---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Navbar from '../../../../components/Navbar.astro';
import NovelReader from '../../../../components/NovelReader';
import { supabase } from '../../../../lib/supabase';

export async function getStaticPaths() {
  const { data: chapters } = await supabase
    .from('chapters')
    .select(`
      chapter_number,
      stories!inner (slug, type, status)
    `)
    .eq('stories.type', 'novel')
    .eq('stories.status', 'published');
  
  return (chapters || []).map((ch: any) => ({
    params: { 
      slug: ch.stories.slug, 
      number: ch.chapter_number.toString() 
    }
  }));
}

const { slug, number } = Astro.params;
const chapterNumber = parseInt(number || '1');

// Récupérer les données depuis Supabase
const { data: novelData } = await supabase
  .from('stories')
  .select('id, title, slug')
  .eq('slug', slug)
  .eq('type', 'novel')
  .eq('status', 'published')
  .single();

if (!novelData) {
  return Astro.redirect('/404');
}

const { data: chapterData } = await supabase
  .from('chapters')
  .select('*')
  .eq('story_id', novelData.id)
  .eq('chapter_number', chapterNumber)
  .single();

if (!chapterData) {
  return Astro.redirect('/404');
}

const { count: totalChapters } = await supabase
  .from('chapters')
  .select('*', { count: 'exact', head: true })
  .eq('story_id', novelData.id);

const novel = {
  id: novelData.id,
  title: novelData.title,
  slug: novelData.slug,
  totalChapters: totalChapters || 0
};

const currentChapter = {
  title: chapterData.title,
  content: chapterData.content || ''
};

const hasNextChapter = chapterNumber < novel.totalChapters;
const hasPrevChapter = chapterNumber > 1;
---

<BaseLayout title={`${currentChapter.title} - ${novel.title}`}>
  <Navbar />
  
  <main class="pt-20 min-h-screen">
    <NovelReader 
      client:load 
      content={currentChapter.content}
      title={novel.title}
      chapterTitle={currentChapter.title}
      chapterNumber={chapterNumber}
      totalChapters={novel.totalChapters}
      storySlug={novel.slug || ''}
      hasNextChapter={hasNextChapter}
      hasPrevChapter={hasPrevChapter}
    />
  </main>
</BaseLayout>

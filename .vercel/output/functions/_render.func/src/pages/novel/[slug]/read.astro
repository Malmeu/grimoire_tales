---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Navbar from '../../../components/Navbar.astro';
import NovelReader from '../../../components/NovelReader';
import { supabase } from '../../../lib/supabase';

export async function getStaticPaths() {
  const { data: stories } = await supabase
    .from('stories')
    .select('slug')
    .eq('type', 'novel')
    .eq('status', 'published');
  
  return (stories || []).map((s: any) => ({
    params: { slug: s.slug }
  }));
}

const { slug } = Astro.params;

// Récupérer les données depuis Supabase
const { data: novelData } = await supabase
  .from('stories')
  .select(`
    *,
    users!stories_author_id_fkey (username, avatar_url),
    chapters (id, title, chapter_number, content)
  `)
  .eq('slug', slug)
  .eq('type', 'novel')
  .eq('status', 'published')
  .single();

if (!novelData) {
  return Astro.redirect('/404');
}

const chapters = (novelData.chapters || []).sort((a: any, b: any) => a.chapter_number - b.chapter_number);

if (chapters.length === 0) {
  return Astro.redirect('/404');
}

const novel = {
  id: novelData.id,
  title: novelData.title,
  slug: novelData.slug,
  author: {
    username: novelData.users?.username || 'Anonyme',
    avatar_url: novelData.users?.avatar_url
  },
  description: novelData.description || '',
  coverUrl: novelData.cover_url,
  genre: novelData.genre,
  totalChapters: chapters.length
};

const firstChapter = chapters[0];
const chapter = {
  number: firstChapter.chapter_number,
  title: firstChapter.title,
  content: firstChapter.content || ''
};
---

<BaseLayout title={`${chapter.title} - ${novel.title}`} description={novel.description}>
  <Navbar />
  
  <main class="pt-20 min-h-screen">
    <NovelReader 
      client:load 
      content={chapter.content}
      title={novel.title}
      chapterTitle={chapter.title}
      chapterNumber={chapter.number}
      totalChapters={novel.totalChapters}
      storySlug={novel.slug || ''}
      hasNextChapter={chapter.number < novel.totalChapters}
      hasPrevChapter={chapter.number > 1}
    />
  </main>
</BaseLayout>

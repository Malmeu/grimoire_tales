import{j as t}from"./jsx-runtime.TBa3i5EZ.js";import{r as a}from"./index.CVf8TyFT.js";import{c as S}from"./wrapper.DVMbrJAx.js";const L="https://ooevpxkcftpemofjantd.supabase.co",M="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vZXZweGtjZnRwZW1vZmphbnRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Njg3ODYsImV4cCI6MjA4MTM0NDc4Nn0.rbUanSpOKtwqcSs71eCLw_K2ywpuWSfG9Ae88hBmu6M",c=S(L,M);function z({storyId:d,chapterId:u}){const[n,o]=a.useState([]),[l,m]=a.useState(""),[_,h]=a.useState(!0),[p,x]=a.useState(!1),[f,b]=a.useState(null);a.useEffect(()=>{N(),k()},[d,u]);const N=async()=>{const{data:{user:e}}=await c.auth.getUser();b(e)},k=async()=>{h(!0);try{const{data:e,error:s}=await c.from("comments").select(`
          id,
          content,
          likes_count,
          created_at,
          users!comments_user_id_fkey (username, avatar_url)
        `).eq("story_id",d).order("created_at",{ascending:!1});s?(console.error("Error loading comments:",s),o([])):o((e||[]).map(r=>({id:r.id,user:{username:r.users?.username||"Anonyme",avatar_url:r.users?.avatar_url},content:r.content,likes_count:r.likes_count||0,created_at:r.created_at})))}catch(e){console.error("Error:",e),o([])}h(!1)},w=async e=>{if(e.preventDefault(),!!l.trim()){if(!f){alert("Vous devez être connecté pour commenter.");return}x(!0);try{const{data:s,error:r}=await c.from("comments").insert({story_id:d,chapter_id:u||null,user_id:f.id,content:l.trim()}).select(`
          id,
          content,
          likes_count,
          created_at,
          users!comments_user_id_fkey (username, avatar_url)
        `).single();if(r)console.error("Error posting comment:",r),alert("Erreur lors de la publication du commentaire.");else if(s){const i={id:s.id,user:{username:s.users?.username||"Vous",avatar_url:s.users?.avatar_url},content:s.content,likes_count:0,created_at:s.created_at};o([i,...n]),m("")}}catch(s){console.error("Error:",s)}x(!1)}},y=async e=>{o(n.map(s=>s.id===e?{...s,likes_count:s.likes_count+1}:s)),await c.from("comments").update({likes_count:n.find(s=>s.id===e).likes_count+1}).eq("id",e)},C=e=>{const s=new Date(e),i=new Date().getTime()-s.getTime(),g=Math.floor(i/6e4),j=Math.floor(i/36e5),v=Math.floor(i/864e5);return g<60?`il y a ${g}min`:j<24?`il y a ${j}h`:v<7?`il y a ${v}j`:s.toLocaleDateString("fr-FR")};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("h3",{className:"font-gothic text-2xl text-gold-old flex items-center gap-3",children:[t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),"Commentaires (",n.length,")"]}),t.jsxs("form",{onSubmit:w,className:"parchment-card p-4 rounded-lg",children:[t.jsx("textarea",{value:l,onChange:e=>m(e.target.value),placeholder:"Partagez votre avis sur cette histoire...",className:"w-full p-3 bg-dark-void/50 border border-gold-old/20 rounded-lg text-parchment-light placeholder-parchment/40 resize-none focus:outline-none focus:border-gold-old/50 transition-colors",rows:3}),t.jsx("div",{className:"flex justify-end mt-3",children:t.jsx("button",{type:"submit",disabled:p||!l.trim(),className:"glow-button px-6 py-2 text-sm disabled:opacity-50",children:p?"Envoi...":"Publier"})})]}),_?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx("div",{className:"incantation-loader"})}):t.jsx("div",{className:"space-y-4",children:n.map(e=>t.jsx("div",{className:"parchment-card p-4 rounded-lg",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-dark-purple flex items-center justify-center text-gold-old font-gothic",children:e.user.avatar_url?t.jsx("img",{src:e.user.avatar_url,alt:e.user.username,className:"w-full h-full rounded-full object-cover"}):e.user.username.charAt(0).toUpperCase()}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"font-medium text-parchment-light",children:e.user.username}),t.jsx("span",{className:"text-xs text-parchment/50",children:C(e.created_at)})]}),t.jsx("p",{className:"text-parchment/80 text-sm leading-relaxed",children:e.content}),t.jsxs("div",{className:"flex items-center gap-4 mt-3",children:[t.jsxs("button",{onClick:()=>y(e.id),className:"flex items-center gap-1 text-sm text-parchment/50 hover:text-gold-old transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),e.likes_count]}),t.jsx("button",{className:"text-sm text-parchment/50 hover:text-gold-old transition-colors",children:"Répondre"})]})]})]})},e.id))})]})}export{z as default};

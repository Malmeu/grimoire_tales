import{c as T}from"./wrapper.DVMbrJAx.js";import"./hoisted.BkoFJ0Lt.js";const Z="https://ooevpxkcftpemofjantd.supabase.co",J="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vZXZweGtjZnRwZW1vZmphbnRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Njg3ODYsImV4cCI6MjA4MTM0NDc4Nn0.rbUanSpOKtwqcSs71eCLw_K2ywpuWSfG9Ae88hBmu6M",m=T(Z,J);let y=null,c=[],n=[],d=null;const M=document.getElementById("story-form"),u=M?.querySelector('button[type="submit"]'),C=document.getElementById("type"),z=document.getElementById("novel-editor-section"),k=document.getElementById("comic-editor-section"),b=document.getElementById("upload-progress");async function O(){const{data:{user:e}}=await m.auth.getUser();if(!e){alert("Vous devez être connecté pour écrire une histoire."),window.location.href="/login";return}d=e}O();C?.addEventListener("change",()=>{const e=C.value==="comic";z&&z.classList.toggle("hidden",e),k&&k.classList.toggle("hidden",!e)});const $=document.getElementById("cover-dropzone"),V=document.getElementById("cover-input");document.getElementById("cover-status");function P(e,t,r){!e||!t||(e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",i=>{i.preventDefault(),e.classList.add("border-gold-old")}),e.addEventListener("dragleave",()=>{e.classList.remove("border-gold-old")}),e.addEventListener("drop",i=>{i.preventDefault(),e.classList.remove("border-gold-old");const a=i.dataTransfer?.files;a&&r(Array.from(a))}),t.addEventListener("change",()=>{t.files&&r(Array.from(t.files))}))}P($,V,e=>{if(e[0]&&e[0].type.startsWith("image/")){y=e[0];const t=new FileReader;t.onload=r=>{$&&($.innerHTML=`
            <img src="${r.target?.result}" alt="Cover preview" class="max-h-48 mx-auto rounded-lg" />
            <p class="text-sm text-gold-old mt-2">✓ ${y.name}</p>
          `)},t.readAsDataURL(e[0])}});const N=document.getElementById("illustrations-dropzone"),W=document.getElementById("illustrations-input"),L=document.getElementById("illustrations-preview");P(N,W,e=>{const t=e.filter(r=>r.type.startsWith("image/"));c=[...c,...t],R()});function R(){L&&(L.innerHTML=c.map((e,t)=>`
        <div class="relative group">
          <img src="${URL.createObjectURL(e)}" alt="Illustration ${t+1}" class="w-full h-24 object-cover rounded" />
          <button type="button" data-idx="${t}" class="remove-illustration absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity">×</button>
        </div>
      `).join(""),L.querySelectorAll(".remove-illustration").forEach(e=>{e.addEventListener("click",t=>{const r=parseInt(t.target.dataset.idx||"0");c.splice(r,1),R()})}))}const q=document.getElementById("pages-dropzone"),H=document.getElementById("pages-input"),B=document.getElementById("pages-preview"),x=document.getElementById("pages-count");P(q,H,e=>{const t=e.filter(r=>r.type.startsWith("image/"));n=[...n,...t],_()});function _(){B&&(B.innerHTML=n.map((e,t)=>`
        <div class="relative group parchment-card p-2 rounded">
          <img src="${URL.createObjectURL(e)}" alt="Page ${t+1}" class="w-full aspect-[3/4] object-cover rounded" />
          <div class="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">Page ${t+1}</div>
          <button type="button" data-idx="${t}" class="remove-page absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity">×</button>
        </div>
      `).join(""),x&&(x.classList.remove("hidden"),x.textContent=`${n.length} planche(s) ajoutée(s)`),B.querySelectorAll(".remove-page").forEach(e=>{e.addEventListener("click",t=>{const r=parseInt(t.target.dataset.idx||"0");n.splice(r,1),_()})}))}async function U(e,t){const{data:r,error:i}=await m.storage.from("images").upload(t,e,{cacheControl:"3600",upsert:!1});if(i)return console.error("Upload error:",i),null;const{data:{publicUrl:a}}=m.storage.from("images").getPublicUrl(r.path);return a}function l(e){b&&(b.classList.remove("hidden"),b.textContent=e)}function X(e){const t=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").substring(0,80),r=Math.random().toString(36).substring(2,8);return`${t}-${r}`}M?.addEventListener("submit",async e=>{if(e.preventDefault(),!d){alert("Vous devez être connecté pour publier une histoire."),window.location.href="/login";return}const t=document.getElementById("title").value.trim(),r=C.value,i=document.getElementById("genre").value,a=document.getElementById("description").value.trim(),A=document.getElementById("tags").value,S=document.getElementById("chapter-title").value.trim(),w=document.getElementById("editor-textarea")?.value.trim()||"";if(!t||!a){alert("Veuillez remplir le titre et la description.");return}if(r==="comic"&&n.length===0){alert("Veuillez ajouter au moins une planche pour votre BD.");return}if(r!=="comic"&&!w){alert("Veuillez écrire le contenu de votre chapitre.");return}u&&(u.disabled=!0,u.textContent="Publication en cours...");try{const p=X(t),F=A.split(",").map(s=>s.trim()).filter(Boolean),I=Date.now();l("Upload de la couverture...");let j=null;if(y){const s=`${d.id}/covers/${I}-${y.name}`;j=await U(y,s)}l("Création de l'histoire...");const{data:g,error:D}=await m.from("stories").insert({title:t,slug:p,description:a,type:r,genre:i,tags:F,author_id:d.id,cover_url:j,status:"published"}).select().single();if(D)throw new Error(D.message);if(r==="comic"){l("Upload des planches (0/"+n.length+")...");const s=[];for(let o=0;o<n.length;o++){l(`Upload des planches (${o+1}/${n.length})...`);const h=n[o],E=`${d.id}/stories/${g.id}/pages/${I}-${o+1}-${h.name}`,v=await U(h,E);v&&s.push(v)}const{error:f}=await m.from("chapters").insert({story_id:g.id,title:S||"Chapitre 1",chapter_number:1,content:"",images:s,word_count:0});if(f)throw new Error(f.message)}else{let s=[];if(c.length>0){l("Upload des illustrations...");for(let o=0;o<c.length;o++){const h=c[o],E=`${d.id}/stories/${g.id}/illustrations/${I}-${o+1}-${h.name}`,v=await U(h,E);v&&s.push(v)}}l("Création du chapitre...");const{error:f}=await m.from("chapters").insert({story_id:g.id,title:S||"Chapitre 1",chapter_number:1,content:w,images:s,word_count:w.split(/\s+/).filter(Boolean).length});if(f)throw new Error(f.message)}l("Publication réussie !"),alert("Histoire publiée avec succès !"),r==="comic"?window.location.href=`/bd/${g.id}`:window.location.href=`/stories/${p}`}catch(p){console.error("Erreur:",p),alert("Erreur lors de la publication: "+(p.message||"Erreur inconnue"))}finally{u&&(u.disabled=!1,u.textContent="Publier l'histoire"),b&&b.classList.add("hidden")}});

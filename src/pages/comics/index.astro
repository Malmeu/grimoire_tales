---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { supabase } from '../../lib/supabase';

// RÃ©cupÃ©rer les comics depuis Supabase
const { data: comics, error } = await supabase
  .from('stories')
  .select(`
    id,
    title,
    slug,
    description,
    cover_url,
    genre,
    tags,
    views,
    created_at,
    author_id,
    users!stories_author_id_fkey (
      username,
      avatar_url
    )
  `)
  .eq('type', 'comic')
  .eq('status', 'published')
  .order('created_at', { ascending: false });

// DonnÃ©es de fallback si pas de donnÃ©es Supabase
const fallbackComics = [
  {
    id: '1',
    title: 'Le Dernier Gardien',
    slug: 'le-dernier-gardien',
    description: 'Dans un futur cyberpunk, le dernier gardien de l\'ancienne magie doit protÃ©ger les secrets du passÃ©.',
    cover_url: 'https://images.unsplash.com/photo-1551269901-5c5e14c25df7?w=800&h=1200&fit=crop',
    genre: 'Sci-Fi',
    tags: ['cyberpunk', 'magie', 'futur'],
    views: 28500,
    users: { username: 'ShadowArtist', avatar_url: null }
  },
  {
    id: '2',
    title: 'Chroniques de l\'Ombre',
    slug: 'chroniques-ombre',
    description: 'Une aventure Ã©pique dans un monde de tÃ©nÃ¨bres oÃ¹ seuls les plus braves survivent.',
    cover_url: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&h=1200&fit=crop',
    genre: 'Dark Fantasy',
    tags: ['fantasy', 'aventure', 'sombre'],
    views: 15200,
    users: { username: 'DarkScribe', avatar_url: null }
  },
  {
    id: '3',
    title: 'NÃ©on Dreams',
    slug: 'neon-dreams',
    description: 'Dans les rues de Neo-Tokyo, une hackeuse dÃ©couvre un secret qui pourrait changer le monde.',
    cover_url: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=800&h=1200&fit=crop',
    genre: 'Cyberpunk',
    tags: ['cyberpunk', 'hacker', 'japon'],
    views: 32100,
    users: { username: 'NeonWriter', avatar_url: null }
  }
];

const displayComics = (comics && comics.length > 0) ? comics : fallbackComics;

const formatViews = (num: number) => {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
};

const genres = ['Tous', 'Sci-Fi', 'Dark Fantasy', 'Cyberpunk', 'Action', 'Romance', 'Horreur'];
---

<BaseLayout 
  title="BD & Comics - Grimoire Tales" 
  description="DÃ©couvrez notre collection de bandes dessinÃ©es et comics. Des histoires visuelles captivantes dans tous les genres."
>
  <Navbar />
  
  <main class="pt-20 pb-20 min-h-screen">
    <!-- Hero Section -->
    <section class="relative py-16 overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-b from-[var(--accent-primary)]/10 to-transparent"></div>
      <div class="relative max-w-6xl mx-auto px-4 text-center">
        <h1 class="gothic-title text-4xl md:text-6xl mb-4">
          ðŸ“š BD & Comics
        </h1>
        <p class="text-[var(--text-secondary)] text-lg max-w-2xl mx-auto mb-8">
          Plongez dans des univers visuels extraordinaires. Des histoires racontÃ©es page par page, 
          avec des illustrations qui donnent vie Ã  l'imaginaire.
        </p>
        
        <!-- Stats -->
        <div class="flex justify-center gap-8 md:gap-16">
          <div class="text-center">
            <div class="text-3xl font-bold text-[var(--accent-primary)]">{displayComics.length}</div>
            <div class="text-[var(--text-secondary)] text-sm">BD disponibles</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-[var(--accent-primary)]">
              {formatViews(displayComics.reduce((acc: number, c: any) => acc + (c.views || 0), 0))}
            </div>
            <div class="text-[var(--text-secondary)] text-sm">Lectures totales</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section class="max-w-6xl mx-auto px-4 py-8">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
        <div class="flex flex-wrap gap-2">
          {genres.map((genre, idx) => (
            <button 
              class={`px-4 py-2 rounded-full text-sm transition-colors ${
                idx === 0 
                  ? 'bg-[var(--accent-primary)] text-white' 
                  : 'bg-[var(--bg-secondary)] text-[var(--text-secondary)] hover:text-[var(--accent-primary)] hover:border-[var(--accent-primary)]/50 border border-[var(--card-border)]'
              }`}
              data-genre={genre}
            >
              {genre}
            </button>
          ))}
        </div>
        
        <div class="flex items-center gap-3">
          <span class="text-[var(--text-secondary)] text-sm">Trier par:</span>
          <select class="px-4 py-2 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-[var(--accent-primary)] focus:outline-none">
            <option value="recent">Plus rÃ©cents</option>
            <option value="popular">Plus populaires</option>
            <option value="views">Plus vus</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Comics Grid -->
    <section class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {displayComics.map((comic: any) => (
          <a 
            href={`/bd/${comic.id}`}
            class="group parchment-card rounded-xl overflow-hidden hover:border-[var(--accent-primary)]/50 transition-all hover:-translate-y-1"
          >
            <div class="relative aspect-[3/4] overflow-hidden">
              <img 
                src={comic.cover_url || 'https://images.unsplash.com/photo-1551269901-5c5e14c25df7?w=800&h=1200&fit=crop'} 
                alt={comic.title}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
              
              <!-- Badge -->
              <div class="absolute top-3 left-3">
                <span class="px-2 py-1 bg-[var(--accent-primary)] text-white text-xs rounded-full">
                  {comic.genre}
                </span>
              </div>
              
              <!-- Views -->
              <div class="absolute top-3 right-3 flex items-center gap-1 px-2 py-1 bg-black/60 rounded-full text-white text-xs">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                {formatViews(comic.views || 0)}
              </div>
              
              <!-- Title overlay -->
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-white font-semibold text-lg mb-1 line-clamp-2">{comic.title}</h3>
                <p class="text-white/70 text-sm">par {comic.users?.username || 'Anonyme'}</p>
              </div>
            </div>
            
            <div class="p-4">
              <p class="text-[var(--text-secondary)] text-sm line-clamp-2 mb-3">
                {comic.description}
              </p>
              
              <div class="flex flex-wrap gap-1">
                {(comic.tags || []).slice(0, 3).map((tag: string) => (
                  <span class="px-2 py-0.5 bg-[var(--bg-primary)] text-[var(--text-secondary)] text-xs rounded">
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          </a>
        ))}
      </div>
      
      {displayComics.length === 0 && (
        <div class="text-center py-16">
          <div class="text-6xl mb-4">ðŸ“š</div>
          <h3 class="text-xl text-[var(--text-primary)] mb-2">Aucune BD disponible</h3>
          <p class="text-[var(--text-secondary)]">Soyez le premier Ã  publier une BD !</p>
          <a href="/write" class="inline-block mt-4 glow-button px-6 py-3">
            CrÃ©er une BD
          </a>
        </div>
      )}
    </section>

    <!-- CTA Section -->
    <section class="max-w-6xl mx-auto px-4 py-16">
      <div class="parchment-card rounded-2xl p-8 md:p-12 text-center">
        <h2 class="gothic-title text-2xl md:text-3xl mb-4">Vous Ãªtes artiste ?</h2>
        <p class="text-[var(--text-secondary)] max-w-xl mx-auto mb-6">
          Partagez vos crÃ©ations avec notre communautÃ©. Publiez vos BD, recevez des retours 
          et construisez votre audience.
        </p>
        <a href="/write" class="glow-button px-8 py-3 text-lg inline-flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Publier une BD
        </a>
      </div>
    </section>
  </main>
  
  <Footer />
</BaseLayout>

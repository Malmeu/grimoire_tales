---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import StoryCard from '../components/StoryCard.astro';
import SearchFilters from '../components/SearchFilters';
import { supabase } from '../lib/supabase';

// Récupérer toutes les histoires publiées depuis Supabase
const { data: storiesData } = await supabase
  .from('stories')
  .select(`
    id,
    title,
    slug,
    cover_url,
    genre,
    tags,
    type,
    views,
    users!stories_author_id_fkey (username)
  `)
  .eq('status', 'published')
  .order('created_at', { ascending: false });

// Transformer les données pour le composant StoryCard
const allStories = (storiesData || []).map((story: any) => ({
  id: story.id,
  title: story.title,
  slug: story.slug,
  author: story.users?.username || 'Anonyme',
  coverUrl: story.cover_url,
  genre: story.genre,
  tags: story.tags || [],
  type: story.type as 'novel' | 'book' | 'comic',
  views: story.views || 0,
  rating: 0
}));

const genres = ['Tous', 'Dark Fantasy', 'Fantasy', 'Sci-Fi', 'Anime', 'Gaming', 'Horreur'];
const types = ['Tous', 'novel', 'book', 'comic'];
const sortOptions = ['Popularité', 'Date', 'Note', 'Vues'];
---

<BaseLayout title="Catalogue" description="Explorez notre collection de novels, livres et BD">
  <Navbar />
  
  <main class="pt-24 pb-20 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="mb-10">
        <h1 class="gothic-title text-4xl md:text-5xl mb-4">Catalogue</h1>
        <p class="text-parchment/70">Découvrez des milliers d'histoires créées par notre communauté</p>
      </div>
      
      <SearchFilters client:load genres={genres} types={types} sortOptions={sortOptions} />
      
      <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {allStories.map(story => (
          <StoryCard {...story} />
        ))}
      </div>
      
      <div class="mt-12 flex justify-center">
        <nav class="flex items-center gap-2">
          <button class="px-4 py-2 parchment-card rounded hover:border-gold-old/50 transition-colors">
            ← Précédent
          </button>
          <span class="px-4 py-2 bg-gold-old/20 text-gold-old rounded">1</span>
          <button class="px-4 py-2 parchment-card rounded hover:border-gold-old/50 transition-colors">2</button>
          <button class="px-4 py-2 parchment-card rounded hover:border-gold-old/50 transition-colors">3</button>
          <span class="text-parchment/50">...</span>
          <button class="px-4 py-2 parchment-card rounded hover:border-gold-old/50 transition-colors">12</button>
          <button class="px-4 py-2 parchment-card rounded hover:border-gold-old/50 transition-colors">
            Suivant →
          </button>
        </nav>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>

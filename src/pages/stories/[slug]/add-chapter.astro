---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Navbar from '../../../components/Navbar.astro';
import Editor from '../../../components/Editor';
import { supabase } from '../../../lib/supabase';

// Désactiver le prerendering pour cette page (rendu SSR dynamique)
export const prerender = false;

const { slug } = Astro.params;

// Récupérer l'histoire
const { data: storyRaw } = await supabase
  .from('stories')
  .select(`
    id,
    title,
    slug,
    author_id,
    type
  `)
  .eq('slug', slug)
  .single();

if (!storyRaw) {
  return Astro.redirect('/404');
}

const story = storyRaw as any;

// Compter les chapitres existants
const { count: chapterCount } = await supabase
  .from('chapters')
  .select('*', { count: 'exact', head: true })
  .eq('story_id', story.id);

const nextChapterNumber = (chapterCount || 0) + 1;
---

<BaseLayout title={`Nouveau chapitre - ${story.title}`}>
  <Navbar />
  
  <main class="pt-24 pb-20 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="mb-8">
        <a href={`/stories/${slug}`} class="text-gold-old hover:text-gold-bright transition-colors mb-4 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Retour à l'histoire
        </a>
        <h1 class="gothic-title text-3xl md:text-4xl mb-2">Nouveau Chapitre</h1>
        <p class="text-parchment/70">
          <span class="text-gold-old">{story.title}</span> - Chapitre {nextChapterNumber}
        </p>
      </div>

      <form id="chapter-form" class="space-y-6" data-story-id={story.id} data-story-slug={story.slug} data-story-type={story.type} data-next-number={nextChapterNumber}>
        <!-- Chapter Title -->
        <div>
          <label for="chapter-title" class="block text-sm text-parchment mb-2">Titre du chapitre *</label>
          <input
            type="text"
            id="chapter-title"
            name="chapter-title"
            required
            class="w-full px-4 py-3 bg-dark-void/50 border border-gold-old/20 rounded-lg text-parchment-light placeholder-parchment/40 focus:outline-none focus:border-gold-old/50 transition-colors text-xl font-gothic"
            placeholder={`Chapitre ${nextChapterNumber}: ...`}
          />
        </div>

        <!-- For comics: Image upload -->
        {story.type === 'comic' && (
          <div>
            <label class="block text-sm text-parchment mb-2">Pages du chapitre (BD)</label>
            <div class="parchment-card p-8 rounded-lg border-2 border-dashed border-gold-old/30 text-center hover:border-gold-old/50 transition-colors cursor-pointer" id="pages-dropzone">
              <svg class="w-12 h-12 mx-auto mb-4 text-parchment/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <p class="text-parchment/70 mb-2">Glissez les images ou cliquez pour sélectionner</p>
              <p class="text-sm text-parchment/50">PNG, JPG - Plusieurs fichiers acceptés</p>
              <input type="file" id="pages-input" accept="image/*" multiple class="hidden" />
            </div>
            <div id="pages-preview" class="grid grid-cols-4 gap-2 mt-4"></div>
          </div>
        )}

        <!-- For novels: Content editor -->
        {story.type !== 'comic' && (
          <div>
            <label class="block text-sm text-parchment mb-2">Contenu du chapitre *</label>
            <Editor client:load placeholder="Écrivez la suite de votre histoire..." />
          </div>
        )}

        <!-- Actions -->
        <div class="flex flex-wrap gap-4 pt-4">
          <button type="submit" class="glow-button px-8 py-3 text-lg">
            Publier le chapitre
          </button>
          <button type="button" class="px-8 py-3 border border-gold-old/50 text-gold-old rounded hover:bg-gold-old/10 transition-colors">
            Sauvegarder en brouillon
          </button>
        </div>
      </form>
    </div>
  </main>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey);

  const form = document.getElementById('chapter-form') as HTMLFormElement;
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  
  const storyId = form?.dataset.storyId;
  const storySlug = form?.dataset.storySlug;
  const storyType = form?.dataset.storyType;
  const nextNumber = parseInt(form?.dataset.nextNumber || '1');

  // Image handling for comics
  let pageImages: string[] = [];
  const pagesDropzone = document.getElementById('pages-dropzone');
  const pagesInput = document.getElementById('pages-input') as HTMLInputElement;
  const pagesPreview = document.getElementById('pages-preview');

  if (pagesDropzone && pagesInput) {
    pagesDropzone.addEventListener('click', () => pagesInput.click());
    
    pagesInput.addEventListener('change', () => {
      if (pagesInput.files) {
        handleFiles(Array.from(pagesInput.files));
      }
    });

    pagesDropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      pagesDropzone.classList.add('border-gold-old');
    });

    pagesDropzone.addEventListener('dragleave', () => {
      pagesDropzone.classList.remove('border-gold-old');
    });

    pagesDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      pagesDropzone.classList.remove('border-gold-old');
      const files = (e as DragEvent).dataTransfer?.files;
      if (files) {
        handleFiles(Array.from(files));
      }
    });
  }

  function handleFiles(files: File[]) {
    files.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target?.result as string;
        pageImages.push(dataUrl);
        updatePreview();
      };
      reader.readAsDataURL(file);
    });
  }

  function updatePreview() {
    if (!pagesPreview) return;
    pagesPreview.innerHTML = pageImages.map((img, idx) => `
      <div class="relative group">
        <img src="${img}" alt="Page ${idx + 1}" class="w-full h-32 object-cover rounded" />
        <button type="button" data-idx="${idx}" class="remove-page absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">×</button>
        <span class="absolute bottom-1 left-1 text-xs bg-black/50 text-white px-1 rounded">${idx + 1}</span>
      </div>
    `).join('');

    // Add remove handlers
    pagesPreview.querySelectorAll('.remove-page').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = parseInt((e.target as HTMLElement).dataset.idx || '0');
        pageImages.splice(idx, 1);
        updatePreview();
      });
    });
  }

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Vérifier l'authentification
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert('Vous devez être connecté pour ajouter un chapitre.');
      window.location.href = '/login';
      return;
    }
    
    const chapterTitle = (document.getElementById('chapter-title') as HTMLInputElement).value.trim();
    const editorTextarea = document.getElementById('editor-textarea') as HTMLTextAreaElement;
    const content = editorTextarea?.value.trim() || '';
    
    // Validation
    if (!chapterTitle) {
      alert('Veuillez entrer un titre pour le chapitre.');
      return;
    }
    
    if (storyType !== 'comic' && !content) {
      alert('Veuillez écrire le contenu du chapitre.');
      return;
    }
    
    if (storyType === 'comic' && pageImages.length === 0) {
      alert('Veuillez ajouter au moins une page pour ce chapitre de BD.');
      return;
    }
    
    // Désactiver le bouton
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Publication en cours...';
    }
    
    try {
      // Créer le chapitre
      const { error: chapterError } = await supabase
        .from('chapters')
        .insert({
          story_id: storyId,
          title: chapterTitle,
          chapter_number: nextNumber,
          content: storyType !== 'comic' ? content : null,
          word_count: storyType !== 'comic' ? content.split(/\s+/).filter(Boolean).length : 0,
          images: storyType === 'comic' ? pageImages : []
        });
      
      if (chapterError) {
        console.error('Erreur création chapitre:', chapterError);
        throw new Error(chapterError.message);
      }
      
      alert('Chapitre publié avec succès !');
      
      // Rediriger vers la page du chapitre
      if (storyType === 'comic') {
        window.location.href = `/bd/${storyId}/chapter/${nextNumber}`;
      } else {
        window.location.href = `/stories/${storySlug}/chapter/${nextNumber}`;
      }
      
    } catch (error: any) {
      console.error('Erreur:', error);
      alert('Erreur lors de la publication: ' + (error.message || 'Erreur inconnue'));
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Publier le chapitre';
      }
    }
  });
</script>

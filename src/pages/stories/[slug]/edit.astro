---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Navbar from '../../../components/Navbar.astro';
import Footer from '../../../components/Footer.astro';
import { supabase } from '../../../lib/supabase';

export const prerender = false;

const { slug } = Astro.params;

// Récupérer l'histoire
const { data: storyData, error } = await supabase
  .from('stories')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !storyData) {
  return Astro.redirect('/profile');
}

const story = storyData as any;

const genres = ['Dark Fantasy', 'Fantasy', 'Sci-Fi', 'Romance', 'Horreur', 'Thriller', 'Aventure', 'Mystère'];
const types = [
  { value: 'novel', label: 'Novel' },
  { value: 'book', label: 'Livre' },
  { value: 'comic', label: 'BD / Comic' },
];
const statuses = [
  { value: 'draft', label: 'Brouillon' },
  { value: 'published', label: 'Publié' },
];
---

<BaseLayout title={`Modifier - ${story.title}`}>
  <Navbar />
  
  <main class="pt-24 pb-20 min-h-screen">
    <div class="max-w-2xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <a href="/profile" class="text-parchment/60 hover:text-gold-old transition-colors flex items-center gap-2 mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Retour au profil
        </a>
        <h1 class="gothic-title text-3xl text-gold-old">Modifier l'histoire</h1>
      </div>
      
      <!-- Formulaire -->
      <form id="edit-form" class="parchment-card rounded-2xl p-6 md:p-8 space-y-6">
        <!-- Titre -->
        <div>
          <label for="title" class="block text-parchment mb-2 font-semibold">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title"
            value={story.title}
            required
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          />
        </div>
        
        <!-- Description -->
        <div>
          <label for="description" class="block text-parchment mb-2 font-semibold">Description</label>
          <textarea 
            id="description" 
            name="description"
            rows="4"
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors resize-none"
          >{story.description}</textarea>
        </div>
        
        <!-- Type et Genre -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="type" class="block text-parchment mb-2 font-semibold">Type *</label>
            <select 
              id="type" 
              name="type"
              required
              class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
            >
              {types.map(t => (
                <option value={t.value} selected={story.type === t.value}>{t.label}</option>
              ))}
            </select>
          </div>
          
          <div>
            <label for="genre" class="block text-parchment mb-2 font-semibold">Genre *</label>
            <select 
              id="genre" 
              name="genre"
              required
              class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
            >
              {genres.map(g => (
                <option value={g} selected={story.genre === g}>{g}</option>
              ))}
            </select>
          </div>
        </div>
        
        <!-- Statut -->
        <div>
          <label for="status" class="block text-parchment mb-2 font-semibold">Statut</label>
          <select 
            id="status" 
            name="status"
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          >
            {statuses.map(s => (
              <option value={s.value} selected={story.status === s.value}>{s.label}</option>
            ))}
          </select>
        </div>
        
        <!-- Tags -->
        <div>
          <label for="tags" class="block text-parchment mb-2 font-semibold">Tags</label>
          <input 
            type="text" 
            id="tags" 
            name="tags"
            value={(story.tags || []).join(', ')}
            placeholder="dark, fantasy, magie (séparés par des virgules)"
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          />
        </div>
        
        <!-- Cover URL -->
        <div>
          <label for="cover_url" class="block text-parchment mb-2 font-semibold">URL de la couverture</label>
          <input 
            type="url" 
            id="cover_url" 
            name="cover_url"
            value={story.cover_url || ''}
            placeholder="https://..."
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          />
          {story.cover_url && (
            <div class="mt-3">
              <img src={story.cover_url} alt="Couverture actuelle" class="w-32 h-48 object-cover rounded-lg" />
            </div>
          )}
        </div>
        
        <!-- Messages -->
        <div id="error-message" class="hidden p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm"></div>
        <div id="success-message" class="hidden p-4 bg-green-500/20 border border-green-500/50 rounded-lg text-green-300 text-sm"></div>
        
        <!-- Boutons -->
        <div class="flex gap-4 pt-4">
          <a href="/profile" class="flex-1 px-6 py-3 border border-gold-old/50 text-gold-old rounded-lg hover:bg-gold-old/10 transition-colors text-center">
            Annuler
          </a>
          <button 
            type="submit" 
            id="submit-btn"
            class="flex-1 glow-button px-6 py-3"
          >
            Enregistrer
          </button>
        </div>
      </form>
      
      <!-- Zone de danger -->
      <div class="mt-8 parchment-card rounded-2xl p-6 border-red-500/30">
        <h2 class="text-red-400 font-semibold mb-4">Zone de danger</h2>
        <p class="text-parchment/60 text-sm mb-4">
          La suppression de cette histoire est irréversible. Tous les chapitres et commentaires seront également supprimés.
        </p>
        <button 
          id="delete-btn"
          class="px-6 py-2 bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors"
        >
          Supprimer cette histoire
        </button>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>

<script define:vars={{ storyId: story.id, storySlug: story.slug, authorId: story.author_id }}>
  window.storyData = { id: storyId, slug: storySlug, authorId: authorId };
</script>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  
  const storyData = (window as any).storyData;
  
  const form = document.getElementById('edit-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  const deleteBtn = document.getElementById('delete-btn');
  
  // Vérifier que l'utilisateur est bien l'auteur
  async function checkOwnership() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session || session.user.id !== storyData.authorId) {
      window.location.href = '/profile';
      return false;
    }
    return true;
  }
  
  checkOwnership();
  
  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    successMessage?.classList.add('hidden');
  }
  
  function showSuccess(message: string) {
    if (successMessage) {
      successMessage.textContent = message;
      successMessage.classList.remove('hidden');
    }
    errorMessage?.classList.add('hidden');
  }
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!await checkOwnership()) return;
    
    const formData = new FormData(form);
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const type = formData.get('type') as string;
    const genre = formData.get('genre') as string;
    const status = formData.get('status') as string;
    const tagsStr = formData.get('tags') as string;
    const cover_url = formData.get('cover_url') as string;
    
    const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
    
    try {
      const { error } = await supabase
        .from('stories')
        .update({
          title,
          description,
          type,
          genre,
          status,
          tags,
          cover_url: cover_url || null,
          updated_at: new Date().toISOString()
        })
        .eq('id', storyData.id);
      
      if (error) throw error;
      
      showSuccess('Histoire mise à jour avec succès !');
      
      setTimeout(() => {
        window.location.href = '/profile';
      }, 1500);
      
    } catch (err: any) {
      console.error('Error:', err);
      showError(err.message || 'Erreur lors de la mise à jour.');
    }
  });
  
  deleteBtn?.addEventListener('click', async () => {
    if (!await checkOwnership()) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette histoire ? Cette action est irréversible.')) {
      try {
        const { error } = await supabase
          .from('stories')
          .delete()
          .eq('id', storyData.id);
        
        if (error) throw error;
        
        alert('Histoire supprimée avec succès.');
        window.location.href = '/profile';
        
      } catch (err: any) {
        console.error('Error:', err);
        alert('Erreur lors de la suppression: ' + err.message);
      }
    }
  });
</script>

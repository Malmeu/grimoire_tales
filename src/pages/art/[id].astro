---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { supabase } from '../../lib/supabase';

export const prerender = false;

const { id } = Astro.params;

// Récupérer l'œuvre d'art
const { data: artwork, error } = await supabase
  .from('artworks')
  .select(`
    id,
    title,
    image_url,
    description,
    category,
    tags,
    views,
    likes_count,
    created_at,
    artist_id,
    users!artworks_artist_id_fkey (
      id,
      username,
      avatar_url,
      bio_geek
    )
  `)
  .eq('id', id)
  .single();

if (error || !artwork) {
  return Astro.redirect('/art');
}

// Incrémenter les vues
await supabase
  .from('artworks')
  .update({ views: (artwork.views || 0) + 1 })
  .eq('id', id);

// Récupérer d'autres œuvres du même artiste
const { data: otherArtworks } = await supabase
  .from('artworks')
  .select('id, title, image_url, category')
  .eq('artist_id', artwork.artist_id)
  .neq('id', id)
  .limit(4);

const categories: Record<string, string> = {
  'illustration': 'Illustration',
  'digital_art': 'Art Digital',
  'traditional': 'Traditionnel',
  'concept_art': 'Concept Art',
  'fan_art': 'Fan Art',
  'horror': 'Horreur',
  'dark_art': 'Art Sombre',
  'fantasy': 'Fantasy',
  'portrait': 'Portrait',
  'landscape': 'Paysage',
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('fr-FR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

const formatViews = (num: number) => {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
};
---

<BaseLayout 
  title={`${artwork.title} - Galerie d'Art`}
  description={artwork.description || `Œuvre d'art par ${artwork.users?.username}`}
>
  <Navbar />
  
  <main class="pt-20 pb-20 min-h-screen">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <ol class="flex items-center gap-2 text-sm text-parchment/60">
          <li><a href="/" class="hover:text-gold-old transition-colors">Accueil</a></li>
          <li>/</li>
          <li><a href="/art" class="hover:text-gold-old transition-colors">Galerie</a></li>
          <li>/</li>
          <li class="text-gold-old">{artwork.title}</li>
        </ol>
      </nav>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Image principale -->
        <div class="lg:col-span-2">
          <div class="relative group">
            <!-- Cadre style musée -->
            <div class="bg-gradient-to-br from-[#8B7355] via-[#6B5344] to-[#4A3728] p-4 md:p-6 rounded-lg shadow-2xl">
              <div class="absolute inset-3 md:inset-4 border border-gold-old/30 rounded pointer-events-none"></div>
              
              <div class="relative overflow-hidden rounded bg-black">
                <img 
                  src={artwork.image_url} 
                  alt={artwork.title}
                  class="w-full h-auto max-h-[80vh] object-contain mx-auto"
                  id="artwork-image"
                />
              </div>
            </div>
            
            <!-- Bouton plein écran -->
            <button 
              id="fullscreen-btn"
              class="absolute top-8 right-8 p-3 bg-black/60 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/80"
              title="Plein écran"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
              </svg>
            </button>
          </div>
          
          <!-- Plaque du tableau -->
          <div class="mt-6 text-center">
            <div class="inline-block bg-gradient-to-r from-[#2a1a1f] via-[#3d2832] to-[#2a1a1f] px-8 py-4 rounded border border-gold-old/30 shadow-lg">
              <h1 class="text-gold-old font-semibold text-xl md:text-2xl mb-2">
                {artwork.title}
              </h1>
              <p class="text-parchment/60 italic">
                par {artwork.users?.username || 'Artiste Anonyme'}
              </p>
            </div>
          </div>
        </div>
        
        <!-- Informations -->
        <div class="space-y-6">
          <!-- Artiste -->
          <div class="parchment-card rounded-xl p-6">
            <h2 class="text-lg font-semibold text-gold-old mb-4">L'Artiste</h2>
            <a href={`/profile?user=${artwork.users?.id}`} class="flex items-center gap-4 group">
              <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-gold-old/30 group-hover:border-gold-old transition-colors">
                <img 
                  src={artwork.users?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${artwork.users?.username}`}
                  alt={artwork.users?.username}
                  class="w-full h-full object-cover"
                />
              </div>
              <div>
                <p class="text-parchment font-semibold group-hover:text-gold-old transition-colors">
                  {artwork.users?.username}
                </p>
                <p class="text-parchment/60 text-sm line-clamp-2">
                  {artwork.users?.bio_geek || 'Artiste sur Grimoire Tales'}
                </p>
              </div>
            </a>
          </div>
          
          <!-- Détails -->
          <div class="parchment-card rounded-xl p-6">
            <h2 class="text-lg font-semibold text-gold-old mb-4">Détails</h2>
            
            <div class="space-y-4">
              <!-- Catégorie -->
              <div class="flex items-center justify-between">
                <span class="text-parchment/60">Catégorie</span>
                <span class="px-3 py-1 bg-gold-old/20 text-gold-old rounded-full text-sm">
                  {categories[artwork.category] || artwork.category}
                </span>
              </div>
              
              <!-- Date -->
              <div class="flex items-center justify-between">
                <span class="text-parchment/60">Exposée le</span>
                <span class="text-parchment">{formatDate(artwork.created_at)}</span>
              </div>
              
              <!-- Vues -->
              <div class="flex items-center justify-between">
                <span class="text-parchment/60">Contemplations</span>
                <span class="text-parchment flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  {formatViews(artwork.views || 0)}
                </span>
              </div>
              
              <!-- Likes -->
              <div class="flex items-center justify-between">
                <span class="text-parchment/60">Admirations</span>
                <span class="text-parchment flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                  {artwork.likes_count || 0}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div class="flex gap-3">
            <button 
              id="like-btn"
              class="flex-1 py-3 border border-gold-old/50 text-gold-old rounded-lg hover:bg-gold-old/10 transition-colors flex items-center justify-center gap-2"
              data-artwork-id={artwork.id}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              <span>J'admire</span>
            </button>
            <button 
              class="p-3 border border-gold-old/50 text-gold-old rounded-lg hover:bg-gold-old/10 transition-colors"
              title="Partager"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
              </svg>
            </button>
          </div>
          
          <!-- Description -->
          {artwork.description && (
            <div class="parchment-card rounded-xl p-6">
              <h2 class="text-lg font-semibold text-gold-old mb-4">Description</h2>
              <p class="text-parchment/80 leading-relaxed whitespace-pre-line">
                {artwork.description}
              </p>
            </div>
          )}
          
          <!-- Tags -->
          {artwork.tags && artwork.tags.length > 0 && (
            <div class="parchment-card rounded-xl p-6">
              <h2 class="text-lg font-semibold text-gold-old mb-4">Tags</h2>
              <div class="flex flex-wrap gap-2">
                {artwork.tags.map((tag: string) => (
                  <span class="px-3 py-1 bg-[var(--bg-primary)] text-parchment/70 rounded-full text-sm">
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
      
      <!-- Autres œuvres de l'artiste -->
      {otherArtworks && otherArtworks.length > 0 && (
        <section class="mt-16">
          <h2 class="gothic-title text-2xl text-gold-old mb-8">
            Autres œuvres de {artwork.users?.username}
          </h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {otherArtworks.map((other: any) => (
              <a 
                href={`/art/${other.id}`}
                class="group parchment-card rounded-xl overflow-hidden hover:border-gold-old/50 transition-all"
              >
                <div class="aspect-square overflow-hidden">
                  <img 
                    src={other.image_url}
                    alt={other.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  />
                </div>
                <div class="p-3">
                  <h3 class="text-parchment text-sm font-medium line-clamp-1 group-hover:text-gold-old transition-colors">
                    {other.title}
                  </h3>
                </div>
              </a>
            ))}
          </div>
        </section>
      )}
      
      <!-- Retour à la galerie -->
      <div class="mt-12 text-center">
        <a 
          href="/art" 
          class="inline-flex items-center gap-2 text-parchment/60 hover:text-gold-old transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Retour à la galerie
        </a>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>

<!-- Modal plein écran -->
<div id="fullscreen-modal" class="fixed inset-0 z-50 bg-black hidden items-center justify-center">
  <button 
    id="close-fullscreen"
    class="absolute top-4 right-4 p-3 text-white hover:text-gold-old transition-colors"
  >
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>
  <img 
    id="fullscreen-image"
    src={artwork.image_url}
    alt={artwork.title}
    class="max-w-full max-h-full object-contain"
  />
</div>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  
  // Plein écran
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const fullscreenModal = document.getElementById('fullscreen-modal');
  const closeFullscreen = document.getElementById('close-fullscreen');
  
  fullscreenBtn?.addEventListener('click', () => {
    fullscreenModal?.classList.remove('hidden');
    fullscreenModal?.classList.add('flex');
    document.body.style.overflow = 'hidden';
  });
  
  closeFullscreen?.addEventListener('click', () => {
    fullscreenModal?.classList.add('hidden');
    fullscreenModal?.classList.remove('flex');
    document.body.style.overflow = '';
  });
  
  fullscreenModal?.addEventListener('click', (e) => {
    if (e.target === fullscreenModal) {
      fullscreenModal.classList.add('hidden');
      fullscreenModal.classList.remove('flex');
      document.body.style.overflow = '';
    }
  });
  
  // Échap pour fermer
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !fullscreenModal?.classList.contains('hidden')) {
      fullscreenModal?.classList.add('hidden');
      fullscreenModal?.classList.remove('flex');
      document.body.style.overflow = '';
    }
  });
  
  // Like
  const likeBtn = document.getElementById('like-btn');
  
  likeBtn?.addEventListener('click', async () => {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      window.location.href = '/login';
      return;
    }
    
    const artworkId = likeBtn.dataset.artworkId;
    
    // Vérifier si déjà liké
    const { data: existingLike } = await supabase
      .from('artwork_likes')
      .select('id')
      .eq('user_id', session.user.id)
      .eq('artwork_id', artworkId)
      .single();
    
    if (existingLike) {
      // Retirer le like
      await supabase
        .from('artwork_likes')
        .delete()
        .eq('id', existingLike.id);
      
      likeBtn.classList.remove('bg-gold-old/20');
    } else {
      // Ajouter le like
      await supabase
        .from('artwork_likes')
        .insert({
          user_id: session.user.id,
          artwork_id: artworkId
        });
      
      likeBtn.classList.add('bg-gold-old/20');
    }
    
    // Rafraîchir la page pour mettre à jour le compteur
    window.location.reload();
  });
  
  // Vérifier si l'utilisateur a déjà liké
  async function checkLikeStatus() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    
    const artworkId = likeBtn?.dataset.artworkId;
    if (!artworkId) return;
    
    const { data: existingLike } = await supabase
      .from('artwork_likes')
      .select('id')
      .eq('user_id', session.user.id)
      .eq('artwork_id', artworkId)
      .single();
    
    if (existingLike && likeBtn) {
      likeBtn.classList.add('bg-gold-old/20');
      const svg = likeBtn.querySelector('svg');
      if (svg) {
        svg.setAttribute('fill', 'currentColor');
      }
    }
  }
  
  checkLikeStatus();
</script>

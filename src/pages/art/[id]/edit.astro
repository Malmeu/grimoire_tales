---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Navbar from '../../../components/Navbar.astro';
import Footer from '../../../components/Footer.astro';
import { supabase } from '../../../lib/supabase';

export const prerender = false;

const { id } = Astro.params;

// Récupérer l'œuvre
const { data: artworkData, error } = await supabase
  .from('artworks')
  .select('*')
  .eq('id', id)
  .single();

if (error || !artworkData) {
  return Astro.redirect('/profile');
}

const artwork = artworkData as any;

const categories = [
  { value: 'illustration', label: 'Illustration' },
  { value: 'digital_art', label: 'Art Digital' },
  { value: 'traditional', label: 'Traditionnel' },
  { value: 'concept_art', label: 'Concept Art' },
  { value: 'fan_art', label: 'Fan Art' },
  { value: 'horror', label: 'Horreur' },
  { value: 'dark_art', label: 'Art Sombre' },
  { value: 'fantasy', label: 'Fantasy' },
  { value: 'portrait', label: 'Portrait' },
  { value: 'landscape', label: 'Paysage' },
];
---

<BaseLayout title={`Modifier - ${artwork.title}`}>
  <Navbar />
  
  <main class="pt-24 pb-20 min-h-screen">
    <div class="max-w-2xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <a href="/profile" class="text-parchment/60 hover:text-gold-old transition-colors flex items-center gap-2 mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Retour au profil
        </a>
        <h1 class="gothic-title text-3xl text-gold-old">Modifier l'œuvre</h1>
      </div>
      
      <!-- Aperçu actuel -->
      <div class="parchment-card rounded-2xl p-6 mb-6">
        <h2 class="text-parchment font-semibold mb-4">Image actuelle</h2>
        <img 
          src={artwork.image_url} 
          alt={artwork.title}
          class="max-h-64 rounded-lg mx-auto"
        />
      </div>
      
      <!-- Formulaire -->
      <form id="edit-form" class="parchment-card rounded-2xl p-6 md:p-8 space-y-6">
        <!-- Titre -->
        <div>
          <label for="title" class="block text-parchment mb-2 font-semibold">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title"
            value={artwork.title}
            required
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          />
        </div>
        
        <!-- Catégorie -->
        <div>
          <label for="category" class="block text-parchment mb-2 font-semibold">Catégorie *</label>
          <select 
            id="category" 
            name="category"
            required
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          >
            {categories.map(cat => (
              <option value={cat.value} selected={artwork.category === cat.value}>{cat.label}</option>
            ))}
          </select>
        </div>
        
        <!-- Description -->
        <div>
          <label for="description" class="block text-parchment mb-2 font-semibold">Description</label>
          <textarea 
            id="description" 
            name="description"
            rows="4"
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors resize-none"
          >{artwork.description}</textarea>
        </div>
        
        <!-- Tags -->
        <div>
          <label for="tags" class="block text-parchment mb-2 font-semibold">Tags</label>
          <input 
            type="text" 
            id="tags" 
            name="tags"
            value={(artwork.tags || []).join(', ')}
            placeholder="dark, fantasy, creature (séparés par des virgules)"
            class="w-full px-4 py-3 bg-[var(--bg-secondary)] border border-[var(--card-border)] rounded-lg text-[var(--text-primary)] focus:border-gold-old focus:outline-none transition-colors"
          />
        </div>
        
        <!-- Messages -->
        <div id="error-message" class="hidden p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm"></div>
        <div id="success-message" class="hidden p-4 bg-green-500/20 border border-green-500/50 rounded-lg text-green-300 text-sm"></div>
        
        <!-- Boutons -->
        <div class="flex gap-4 pt-4">
          <a href="/profile" class="flex-1 px-6 py-3 border border-gold-old/50 text-gold-old rounded-lg hover:bg-gold-old/10 transition-colors text-center">
            Annuler
          </a>
          <button 
            type="submit" 
            id="submit-btn"
            class="flex-1 glow-button px-6 py-3"
          >
            Enregistrer
          </button>
        </div>
      </form>
      
      <!-- Zone de danger -->
      <div class="mt-8 parchment-card rounded-2xl p-6 border-red-500/30">
        <h2 class="text-red-400 font-semibold mb-4">Zone de danger</h2>
        <p class="text-parchment/60 text-sm mb-4">
          La suppression de cette œuvre est irréversible.
        </p>
        <button 
          id="delete-btn"
          class="px-6 py-2 bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors"
        >
          Supprimer cette œuvre
        </button>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>

<script define:vars={{ artworkId: artwork.id, artistId: artwork.artist_id }}>
  window.artworkData = { id: artworkId, artistId: artistId };
</script>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  
  const artworkData = (window as any).artworkData;
  
  const form = document.getElementById('edit-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  const deleteBtn = document.getElementById('delete-btn');
  
  // Vérifier que l'utilisateur est bien l'artiste
  async function checkOwnership() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session || session.user.id !== artworkData.artistId) {
      window.location.href = '/profile';
      return false;
    }
    return true;
  }
  
  checkOwnership();
  
  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    successMessage?.classList.add('hidden');
  }
  
  function showSuccess(message: string) {
    if (successMessage) {
      successMessage.textContent = message;
      successMessage.classList.remove('hidden');
    }
    errorMessage?.classList.add('hidden');
  }
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!await checkOwnership()) return;
    
    const formData = new FormData(form);
    const title = formData.get('title') as string;
    const category = formData.get('category') as string;
    const description = formData.get('description') as string;
    const tagsStr = formData.get('tags') as string;
    
    const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
    
    try {
      const { error } = await supabase
        .from('artworks')
        .update({
          title,
          category,
          description,
          tags,
          updated_at: new Date().toISOString()
        })
        .eq('id', artworkData.id);
      
      if (error) throw error;
      
      showSuccess('Œuvre mise à jour avec succès !');
      
      setTimeout(() => {
        window.location.href = '/profile';
      }, 1500);
      
    } catch (err: any) {
      console.error('Error:', err);
      showError(err.message || 'Erreur lors de la mise à jour.');
    }
  });
  
  deleteBtn?.addEventListener('click', async () => {
    if (!await checkOwnership()) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette œuvre ? Cette action est irréversible.')) {
      try {
        const { error } = await supabase
          .from('artworks')
          .delete()
          .eq('id', artworkData.id);
        
        if (error) throw error;
        
        alert('Œuvre supprimée avec succès.');
        window.location.href = '/profile';
        
      } catch (err: any) {
        console.error('Error:', err);
        alert('Erreur lors de la suppression: ' + err.message);
      }
    }
  });
</script>

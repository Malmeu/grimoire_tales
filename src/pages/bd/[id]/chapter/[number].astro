---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Navbar from '../../../../components/Navbar.astro';
import BDReader from '../../../../components/BDReader';
import { supabase } from '../../../../lib/supabase';

export async function getStaticPaths() {
  const { data: chapters } = await supabase
    .from('chapters')
    .select(`
      chapter_number,
      story_id,
      stories!inner (id, type, status)
    `)
    .eq('stories.type', 'comic')
    .eq('stories.status', 'published');
  
  return (chapters || []).map((ch: any) => ({
    params: { 
      id: ch.story_id, 
      number: ch.chapter_number.toString() 
    }
  }));
}

const { id, number } = Astro.params;
const chapterNumber = parseInt(number || '1');

// R√©cup√©rer les donn√©es depuis Supabase
const { data: bdData } = await supabase
  .from('stories')
  .select(`
    *,
    users!stories_author_id_fkey (username, avatar_url)
  `)
  .eq('id', id)
  .eq('type', 'comic')
  .eq('status', 'published')
  .single();

if (!bdData) {
  return Astro.redirect('/404');
}

const { data: chapterData } = await supabase
  .from('chapters')
  .select('*')
  .eq('story_id', id)
  .eq('chapter_number', chapterNumber)
  .single();

if (!chapterData) {
  return Astro.redirect('/404');
}

const { count: totalChapters } = await supabase
  .from('chapters')
  .select('*', { count: 'exact', head: true })
  .eq('story_id', id);

const bd = {
  id: bdData.id,
  title: bdData.title,
  author: {
    username: bdData.users?.username || 'Anonyme',
    avatar_url: bdData.users?.avatar_url
  },
  description: bdData.description || '',
  genre: bdData.genre,
  totalChapters: totalChapters || 0
};

const currentChapter = {
  title: chapterData.title,
  pages: chapterData.images || []
};

const hasNextChapter = chapterNumber < bd.totalChapters;
const hasPrevChapter = chapterNumber > 1;
---

<BaseLayout title={`${currentChapter.title} - ${bd.title}`} description={bd.description}>
  <Navbar />
  
  <main class="pt-20 pb-8 min-h-screen">
    <!-- Header with navigation -->
    <div class="fixed top-16 left-0 right-0 z-40 glass-dark border-b border-[var(--card-border)]">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href={`/bd/${id}`} class="flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            <span class="hidden sm:inline">{bd.title}</span>
          </a>
        </div>
        
        <div class="flex items-center gap-2">
          <span class="text-[var(--accent-primary)] text-sm font-medium">{currentChapter.title}</span>
          <span class="text-[var(--text-secondary)] text-sm">
            ({chapterNumber}/{bd.totalChapters})
          </span>
        </div>
        
        <div class="flex items-center gap-2">
          {hasPrevChapter && (
            <a 
              href={`/bd/${id}/chapter/${chapterNumber - 1}`}
              class="p-2 text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors"
              title="Chapitre pr√©c√©dent"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </a>
          )}
          {hasNextChapter && (
            <a 
              href={`/bd/${id}/chapter/${chapterNumber + 1}`}
              class="p-2 text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors"
              title="Chapitre suivant"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          )}
        </div>
      </div>
    </div>

    <!-- BD Reader -->
    <section class="max-w-7xl mx-auto px-2 md:px-4 pt-16">
      <BDReader 
        client:load 
        pages={currentChapter.pages} 
        title={bd.title}
        chapterTitle={currentChapter.title}
        hasNextChapter={hasNextChapter}
        hasPrevChapter={hasPrevChapter}
      />
    </section>

    <!-- Chapter Navigation Footer -->
    <nav class="max-w-6xl mx-auto px-4 mt-8 pt-8 border-t border-[var(--card-border)]">
      <div class="flex items-center justify-between">
        {hasPrevChapter ? (
          <a 
            href={`/bd/${id}/chapter/${chapterNumber - 1}`}
            class="flex items-center gap-2 px-6 py-3 parchment-card rounded-lg hover:border-[var(--accent-primary)]/50 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            <div class="text-left">
              <span class="text-[var(--text-secondary)] text-xs block">Pr√©c√©dent</span>
              <span class="text-[var(--text-primary)]">Chapitre {chapterNumber - 1}</span>
            </div>
          </a>
        ) : (
          <div></div>
        )}
        
        <a 
          href={`/bd/${id}`}
          class="px-4 py-2 text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors"
        >
          üìö Tous les chapitres
        </a>
        
        {hasNextChapter ? (
          <a 
            href={`/bd/${id}/chapter/${chapterNumber + 1}`}
            class="flex items-center gap-2 px-6 py-3 glow-button"
          >
            <div class="text-right">
              <span class="text-xs block opacity-80">Suivant</span>
              <span>Chapitre {chapterNumber + 1}</span>
            </div>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        ) : (
          <a 
            href={`/bd/${id}`}
            class="flex items-center gap-2 px-6 py-3 glow-button"
          >
            <span>Fin de la BD</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </a>
        )}
      </div>
    </nav>
  </main>
</BaseLayout>

---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Navbar from '../../../../components/Navbar.astro';
import NovelReader from '../../../../components/NovelReader';
import { supabase } from '../../../../lib/supabase';

// Désactiver le prerendering pour cette page (rendu SSR dynamique)
export const prerender = false;

const { slug, number } = Astro.params;
const chapterNumber = parseInt(number || '1');

// Récupérer les données depuis Supabase
const { data: novelDataRaw } = await supabase
  .from('stories')
  .select('id, title, slug')
  .eq('slug', slug)
  .eq('type', 'novel')
  .eq('status', 'published')
  .single();

if (!novelDataRaw) {
  return Astro.redirect('/404');
}

const novelData = novelDataRaw as any;

const { data: chapterDataRaw } = await supabase
  .from('chapters')
  .select('*')
  .eq('story_id', novelData.id)
  .eq('chapter_number', chapterNumber)
  .single();

if (!chapterDataRaw) {
  return Astro.redirect('/404');
}

const chapterData = chapterDataRaw as any;

const { count: totalChapters } = await supabase
  .from('chapters')
  .select('*', { count: 'exact', head: true })
  .eq('story_id', novelData.id);

const novel = {
  id: novelData.id,
  title: novelData.title,
  slug: novelData.slug,
  totalChapters: totalChapters || 0
};

const currentChapter = {
  title: chapterData.title,
  content: chapterData.content || ''
};

const hasNextChapter = chapterNumber < novel.totalChapters;
const hasPrevChapter = chapterNumber > 1;
---

<BaseLayout title={`${currentChapter.title} - ${novel.title}`}>
  <Navbar />
  
  <main class="pt-20 min-h-screen">
    <NovelReader 
      client:load 
      content={currentChapter.content}
      title={novel.title}
      chapterTitle={currentChapter.title}
      chapterNumber={chapterNumber}
      totalChapters={novel.totalChapters}
      storySlug={novel.slug || ''}
      hasNextChapter={hasNextChapter}
      hasPrevChapter={hasPrevChapter}
    />
  </main>
</BaseLayout>

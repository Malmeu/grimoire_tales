import{c as w}from"./wrapper.DVMbrJAx.js";import"./hoisted.BkoFJ0Lt.js";const B="https://ooevpxkcftpemofjantd.supabase.co",L="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vZXZweGtjZnRwZW1vZmphbnRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Njg3ODYsImV4cCI6MjA4MTM0NDc4Nn0.rbUanSpOKtwqcSs71eCLw_K2ywpuWSfG9Ae88hBmu6M",d=w(B,L),t=document.getElementById("cover-dropzone"),s=document.getElementById("cover-input");let u=null;t?.addEventListener("click",()=>s?.click());t?.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("border-gold-old")});t?.addEventListener("dragleave",()=>{t.classList.remove("border-gold-old")});t?.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("border-gold-old");const r=e.dataTransfer?.files;r?.[0]&&f(r[0])});s?.addEventListener("change",()=>{s.files?.[0]&&f(s.files[0])});function f(e){if(!e.type.startsWith("image/"))return;const r=new FileReader;r.onload=n=>{u=n.target?.result,t&&(t.innerHTML=`<img src="${u}" alt="Cover preview" class="max-h-48 mx-auto rounded-lg" />`)},r.readAsDataURL(e)}function C(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").substring(0,100)}const v=document.getElementById("story-form"),o=v?.querySelector('button[type="submit"]');v?.addEventListener("submit",async e=>{e.preventDefault();const{data:{user:r}}=await d.auth.getUser();if(!r){alert("Vous devez être connecté pour publier une histoire."),window.location.href="/login";return}const n=document.getElementById("title").value.trim(),m=document.getElementById("type").value,h=document.getElementById("genre").value,p=document.getElementById("description").value.trim(),b=document.getElementById("tags").value,I=document.getElementById("chapter-title").value.trim(),a=document.getElementById("editor-textarea")?.value.trim()||"";if(!n||!p||!a){alert("Veuillez remplir tous les champs obligatoires (titre, description, contenu).");return}o&&(o.disabled=!0,o.textContent="Publication en cours...");try{const i=C(n),y=b.split(",").map(E=>E.trim()).filter(Boolean),{data:g,error:l}=await d.from("stories").insert({title:n,slug:i,description:p,type:m,genre:h,tags:y,author_id:r.id,cover_url:u||null,status:"published"}).select().single();if(l)throw console.error("Erreur création histoire:",l),new Error(l.message);const{error:c}=await d.from("chapters").insert({story_id:g.id,title:I||"Chapitre 1",chapter_number:1,content:a,word_count:a.split(/\s+/).filter(Boolean).length});if(c)throw console.error("Erreur création chapitre:",c),new Error(c.message);alert("Histoire publiée avec succès !"),m==="comic"?window.location.href=`/bd/${g.id}`:window.location.href=`/stories/${i}`}catch(i){console.error("Erreur:",i),alert("Erreur lors de la publication: "+(i.message||"Erreur inconnue"))}finally{o&&(o.disabled=!1,o.textContent="Publier l'histoire")}});
